<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>STM8s Brushless MCP: BLDC State</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">STM8s Brushless MCP
   &#160;<span id="projectnumber">0.1</span>
   </div>
   <div id="projectbrief">Brushless motor controller on STM8s</div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.svg"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('group___b_l_d_c__sm.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">BLDC State</div>  </div>
</div><!--header-->
<div class="contents">

<p>BLDC state management and timing control.  
<a href="#details">More...</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:ga6af60a6d9b9c041b0b35af96cb8cd00e"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group___b_l_d_c__sm.html#ga6af60a6d9b9c041b0b35af96cb8cd00e">BL_reset</a> (void)</td></tr>
<tr class="memdesc:ga6af60a6d9b9c041b0b35af96cb8cd00e"><td class="mdescLeft">&#160;</td><td class="mdescRight">Initialize/reset motor.  <a href="group___b_l_d_c__sm.html#ga6af60a6d9b9c041b0b35af96cb8cd00e">More...</a><br /></td></tr>
<tr class="separator:ga6af60a6d9b9c041b0b35af96cb8cd00e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga0969fa54a690ff0550a3ae62d8c4bd2b"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group___b_l_d_c__sm.html#ga0969fa54a690ff0550a3ae62d8c4bd2b">BL_set_speed</a> (uint16_t ui_mspeed_counts)</td></tr>
<tr class="memdesc:ga0969fa54a690ff0550a3ae62d8c4bd2b"><td class="mdescLeft">&#160;</td><td class="mdescRight">Sets motor speed from commanded throttle/UI setting.  <a href="group___b_l_d_c__sm.html#ga0969fa54a690ff0550a3ae62d8c4bd2b">More...</a><br /></td></tr>
<tr class="separator:ga0969fa54a690ff0550a3ae62d8c4bd2b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga1318388de3285a57badb666d488e2dd1"><td class="memItemLeft" align="right" valign="top">uint16_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group___b_l_d_c__sm.html#ga1318388de3285a57badb666d488e2dd1">BL_get_speed</a> (void)</td></tr>
<tr class="memdesc:ga1318388de3285a57badb666d488e2dd1"><td class="mdescLeft">&#160;</td><td class="mdescRight">Accessor for Commanded Duty Cycle.  <a href="group___b_l_d_c__sm.html#ga1318388de3285a57badb666d488e2dd1">More...</a><br /></td></tr>
<tr class="separator:ga1318388de3285a57badb666d488e2dd1"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga6e3d36776ad0e26e22b6ebd1259498a6"><td class="memItemLeft" align="right" valign="top"><a id="ga6e3d36776ad0e26e22b6ebd1259498a6"></a>
void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group___b_l_d_c__sm.html#ga6e3d36776ad0e26e22b6ebd1259498a6">_BL_timing_step_slower</a> (uint16_t current_setpoint)</td></tr>
<tr class="memdesc:ga6e3d36776ad0e26e22b6ebd1259498a6"><td class="mdescLeft">&#160;</td><td class="mdescRight">adjust commutation timing by step amount <br /></td></tr>
<tr class="separator:ga6e3d36776ad0e26e22b6ebd1259498a6"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga12cae642beded2df15db145ae7570670"><td class="memItemLeft" align="right" valign="top"><a id="ga12cae642beded2df15db145ae7570670"></a>
void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group___b_l_d_c__sm.html#ga12cae642beded2df15db145ae7570670">_BL_timing_step_faster</a> (uint16_t current_setpoint)</td></tr>
<tr class="memdesc:ga12cae642beded2df15db145ae7570670"><td class="mdescLeft">&#160;</td><td class="mdescRight">adjust commutation timing by step amount <br /></td></tr>
<tr class="separator:ga12cae642beded2df15db145ae7570670"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gafd1aaf514a747274b20d225d8740db5b"><td class="memItemLeft" align="right" valign="top">uint16_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group___b_l_d_c__sm.html#gafd1aaf514a747274b20d225d8740db5b">BL_get_timing</a> (void)</td></tr>
<tr class="memdesc:gafd1aaf514a747274b20d225d8740db5b"><td class="mdescLeft">&#160;</td><td class="mdescRight">Accessor for commutation period.  <a href="group___b_l_d_c__sm.html#gafd1aaf514a747274b20d225d8740db5b">More...</a><br /></td></tr>
<tr class="separator:gafd1aaf514a747274b20d225d8740db5b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gaa9e10758684fb492c312db1b5fd0fca1"><td class="memItemLeft" align="right" valign="top"><a id="gaa9e10758684fb492c312db1b5fd0fca1"></a>
void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group___b_l_d_c__sm.html#gaa9e10758684fb492c312db1b5fd0fca1">BL_set_timing</a> (uint16_t u16)</td></tr>
<tr class="memdesc:gaa9e10758684fb492c312db1b5fd0fca1"><td class="mdescLeft">&#160;</td><td class="mdescRight">Accessor for commutation period. <br /></td></tr>
<tr class="separator:gaa9e10758684fb492c312db1b5fd0fca1"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga442d26a780c245d8e7b59ddf1917e67d"><td class="memItemLeft" align="right" valign="top"><a class="el" href="bldc__sm_8h.html#a6d97331b7d9c5e41e55e28a253cf2a5a">BL_RUNSTATE_t</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group___b_l_d_c__sm.html#ga442d26a780c245d8e7b59ddf1917e67d">BL_get_state</a> (void)</td></tr>
<tr class="memdesc:ga442d26a780c245d8e7b59ddf1917e67d"><td class="mdescLeft">&#160;</td><td class="mdescRight">Accessor for state variable.  <a href="group___b_l_d_c__sm.html#ga442d26a780c245d8e7b59ddf1917e67d">More...</a><br /></td></tr>
<tr class="separator:ga442d26a780c245d8e7b59ddf1917e67d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga59982f0e1f4adc6e81ca7ced408e34a1"><td class="memItemLeft" align="right" valign="top"><a id="ga59982f0e1f4adc6e81ca7ced408e34a1"></a>
void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group___b_l_d_c__sm.html#ga59982f0e1f4adc6e81ca7ced408e34a1">BL_set_opstate</a> (uint8_t opstate)</td></tr>
<tr class="memdesc:ga59982f0e1f4adc6e81ca7ced408e34a1"><td class="mdescLeft">&#160;</td><td class="mdescRight">Accessor for state variable. <br /></td></tr>
<tr class="separator:ga59982f0e1f4adc6e81ca7ced408e34a1"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga7b6ee98dc16ca5eb6d3af057b42bae22"><td class="memItemLeft" align="right" valign="top">uint8_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group___b_l_d_c__sm.html#ga7b6ee98dc16ca5eb6d3af057b42bae22">BL_get_opstate</a> (void)</td></tr>
<tr class="memdesc:ga7b6ee98dc16ca5eb6d3af057b42bae22"><td class="mdescLeft">&#160;</td><td class="mdescRight">Accessor for state variable.  <a href="group___b_l_d_c__sm.html#ga7b6ee98dc16ca5eb6d3af057b42bae22">More...</a><br /></td></tr>
<tr class="separator:ga7b6ee98dc16ca5eb6d3af057b42bae22"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga476266c1309db823d62781e7ca1870c2"><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group___b_l_d_c__sm.html#ga476266c1309db823d62781e7ca1870c2">BL_cl_control</a> (uint16_t current_setpoint)</td></tr>
<tr class="memdesc:ga476266c1309db823d62781e7ca1870c2"><td class="mdescLeft">&#160;</td><td class="mdescRight">@ brief closed loop controller @ return boolean true (success) false (fail)  <a href="group___b_l_d_c__sm.html#ga476266c1309db823d62781e7ca1870c2">More...</a><br /></td></tr>
<tr class="separator:ga476266c1309db823d62781e7ca1870c2"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga56ff59a3320f7f1a4f1b37ca6e35d91a"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group___b_l_d_c__sm.html#ga56ff59a3320f7f1a4f1b37ca6e35d91a">BL_State_Ctrl</a> (void)</td></tr>
<tr class="memdesc:ga56ff59a3320f7f1a4f1b37ca6e35d91a"><td class="mdescLeft">&#160;</td><td class="mdescRight">Implement control task (fixed exec rate of ~1ms).  <a href="group___b_l_d_c__sm.html#ga56ff59a3320f7f1a4f1b37ca6e35d91a">More...</a><br /></td></tr>
<tr class="separator:ga56ff59a3320f7f1a4f1b37ca6e35d91a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga192c8657cef82c7403f70f6d88bc7128"><td class="memItemLeft" align="right" valign="top"><a id="ga192c8657cef82c7403f70f6d88bc7128"></a>
void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group___b_l_d_c__sm.html#ga192c8657cef82c7403f70f6d88bc7128">BL_Commutation_Step</a> (void)</td></tr>
<tr class="memdesc:ga192c8657cef82c7403f70f6d88bc7128"><td class="mdescLeft">&#160;</td><td class="mdescRight">commutation sequence step (timer ISR callback) <br /></td></tr>
<tr class="separator:ga192c8657cef82c7403f70f6d88bc7128"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<p>BLDC state management and timing control. </p>
<h2 class="groupheader">Function Documentation</h2>
<a id="ga476266c1309db823d62781e7ca1870c2"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga476266c1309db823d62781e7ca1870c2">&#9670;&nbsp;</a></span>BL_cl_control()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool BL_cl_control </td>
          <td>(</td>
          <td class="paramtype">uint16_t&#160;</td>
          <td class="paramname"><em>current_setpoint</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>@ brief closed loop controller @ return boolean true (success) false (fail) </p>
<p>closed loop control function </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">current_setpoint</td><td>commutation period </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>TRUE: within control limits, FALSE: not within control limits </dd></dl>

</div>
</div>
<a id="ga7b6ee98dc16ca5eb6d3af057b42bae22"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga7b6ee98dc16ca5eb6d3af057b42bae22">&#9670;&nbsp;</a></span>BL_get_opstate()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">uint8_t BL_get_opstate </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Accessor for state variable. </p>
<dl class="section return"><dt>Returns</dt><dd>operation state </dd></dl>

</div>
</div>
<a id="ga1318388de3285a57badb666d488e2dd1"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga1318388de3285a57badb666d488e2dd1">&#9670;&nbsp;</a></span>BL_get_speed()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">uint16_t BL_get_speed </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Accessor for Commanded Duty Cycle. </p>
<dl class="section return"><dt>Returns</dt><dd>PWM period </dd></dl>

</div>
</div>
<a id="ga442d26a780c245d8e7b59ddf1917e67d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga442d26a780c245d8e7b59ddf1917e67d">&#9670;&nbsp;</a></span>BL_get_state()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="bldc__sm_8h.html#a6d97331b7d9c5e41e55e28a253cf2a5a">BL_RUNSTATE_t</a> BL_get_state </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Accessor for state variable. </p>
<p>External modules can query if the machine is running or not. There are only these two states bases on the set speed greater or less than the shutdown threshold.</p>
<dl class="section return"><dt>Returns</dt><dd>state value </dd></dl>

</div>
</div>
<a id="gafd1aaf514a747274b20d225d8740db5b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#gafd1aaf514a747274b20d225d8740db5b">&#9670;&nbsp;</a></span>BL_get_timing()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">uint16_t BL_get_timing </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Accessor for commutation period. </p>
<dl class="section return"><dt>Returns</dt><dd>commutation period </dd></dl>

</div>
</div>
<a id="ga6af60a6d9b9c041b0b35af96cb8cd00e"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga6af60a6d9b9c041b0b35af96cb8cd00e">&#9670;&nbsp;</a></span>BL_reset()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void BL_reset </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Initialize/reset motor. </p>
<p>System reset / re-arm function (has to be called both at program startup as well as following a fault condition state.</p>
<p>expect to be called from non-ISR/CS context (i.e. from UI handler) </p>

</div>
</div>
<a id="ga0969fa54a690ff0550a3ae62d8c4bd2b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga0969fa54a690ff0550a3ae62d8c4bd2b">&#9670;&nbsp;</a></span>BL_set_speed()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void BL_set_speed </td>
          <td>(</td>
          <td class="paramtype">uint16_t&#160;</td>
          <td class="paramname"><em>ui_mspeed_counts</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Sets motor speed from commanded throttle/UI setting. </p>
<p>The motor is started once reaching the ramp speed threshold, and allowed to slow down to the low shutoff threshold. UI Speed is shared with background task so this function should be invoked only from within a CS.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">ui_mspeed_counts</td><td>The desired motor output in tetms of timer counts </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a id="ga56ff59a3320f7f1a4f1b37ca6e35d91a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga56ff59a3320f7f1a4f1b37ca6e35d91a">&#9670;&nbsp;</a></span>BL_State_Ctrl()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void BL_State_Ctrl </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Implement control task (fixed exec rate of ~1ms). </p>
<p>fixed-rate controller update (timer ISR callback). </p>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
